<!DOCTYPE html>
<html>
<head>
    <title>XSS Diagnostic Tool</title>
    <style>#victimFrame { width: 100%; height: 500px; border: 2px solid red; }</style>
</head>
<body>
    <h2>Diagnostic Tool</h2>
    <button onclick="startDiagnostics()">Start Diagnostics</button>
    <iframe id="victimFrame" src="https://shop.app/"></iframe>
    <script>
        function startDiagnostics() {
            const frame = document.getElementById('victimFrame');
            const frameWindow = frame.contentWindow;
            const frameDoc = frame.contentDocument;

            // Inject a script into the iframe to set up listeners
            const script = frameDoc.createElement('script');
            script.textContent = `
                // Log all hash changes
                window.addEventListener('hashchange', function(event) {
                    console.log('[DIAG] Hashchange event fired!', event.oldURL, ' -> ', event.newURL);
                });

                // Hook the specific Bt() function to see if it's called and what it returns
                // First, check if Bt exists and is a function
                if (typeof Bt === 'function') {
                    console.log('[DIAG] Bt() function is present. Original function:', Bt);
                    // Store the original function
                    const originalBt = Bt;
                    // Override it to add logging
                    Bt = function(o, u) {
                        console.log('[DIAG] Bt() was called with input:', o);
                        const result = originalBt(o, u);
                        console.log('[DIAG] Bt() returned:', result);
                        return result;
                    };
                } else {
                    console.log('[DIAG] Bt() function NOT found on this page.');
                }

                // Hook the leaveBreadcrumb function too
                if (typeof d !== 'undefined' && d && typeof d.leaveBreadcrumb === 'function') {
                    console.log('[DIAG] d.leaveBreadcrumb() is present.');
                    const originalLeave = d.leaveBreadcrumb;
                    d.leaveBreadcrumb = function() {
                        console.log('[DIAG] leaveBreadcrumb() called with args:', arguments);
                        return originalLeave.apply(this, arguments);
                    };
                }
            `;
            (frameDoc.head || frameDoc.documentElement).appendChild(script);
            console.log("Diagnostics injected.");
        }
    </script>
</body>
</html>
